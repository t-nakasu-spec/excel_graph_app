// ================================
// 設定
// ================================
const OPENAI_API_KEY = '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';
const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
const MODEL_NAME = 'gpt-4.1-mini'; // 軽量・安価・要約向き

/**
 * 選択したセルの内容をAIで要約する
 */
function summarizeSelectedData() {
  const ui = SpreadsheetApp.getUi();
  const sheet = SpreadsheetApp.getActiveSheet();
  const range = sheet.getActiveRange();

  if (!range) {
    ui.alert('範囲が選択されていません。');
    return;
  }

  const values = range.getValues();
  const textData = values
    .map(row => row.map(v => v == null ? '' : String(v)).join(' '))
    .join('\n')
    .trim();

  if (!textData) {
    ui.alert('選択範囲にテキストがありません。');
    return;
  }

  const messages = [
    {
      role: 'system',
      content: 'あなたは勤務経験30年のベテラン社員です。'
    },
    {
      role: 'user',
      content: `
以下のスプレッドシートの内容を新入社員に分かり易く説明してください。
先生が授業で話すような丁寧な口語体で説明する。
分かり難い所は分かり易い表現で言い直したり、
時には例や比喩を交えて理解しやすいように補足する。


データ：
${textData}
`
    }
  ];

  const payload = {
    model: MODEL_NAME,
    messages: messages,
    temperature: 0.3
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    headers: {
      Authorization: 'Bearer ' + OPENAI_API_KEY
    },
    payload: JSON.stringify(payload),
    muteHttpExceptions: true
  };

  try {
    const response = UrlFetchApp.fetch(OPENAI_API_URL, options);
    const status = response.getResponseCode();
    const bodyText = response.getContentText();

    if (status !== 200) {
      ui.alert(`APIエラー（${status}）\n${bodyText}`);
      return;
    }

    const result = JSON.parse(bodyText);
    const summary = result?.choices?.[0]?.message?.content;

    if (!summary) {
      Logger.log(result);
      ui.alert('取得に失敗しました（ログを確認してください）');
      return;
    }

    ui.alert('【結果】\n\n' + summary);

  } catch (e) {
    ui.alert('エラーが発生しました：\n' + e.message);
  }
}