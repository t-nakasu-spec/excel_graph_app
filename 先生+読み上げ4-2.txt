<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>éŸ³å£°èª­ã¿ä¸Šã’ãƒ‘ãƒãƒ«</title>
  <style>
    :root{
      --primary:#1a73e8;
      --primary-2:#1557b0;
      --primary-ring:rgba(26,115,232,.35);
      --text:#222;
      --muted:#6b7280;
      --surface:#ffffff;
      --bg:#f6f8fb;
      --card-shadow:0 10px 24px rgba(24,40,72,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:18px 12px;
      background:var(--bg);
      font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",sans-serif;
      color:var(--text);
      display:flex; align-items:flex-start; justify-content:center;
    }

    /* ã‚µã‚¤ãƒ‰ãƒãƒ¼å†…ã§ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¹…ã‚’é©åº¦ã«æŠ‘ãˆã‚‹ï¼ˆä¸­å¤®å¯„ã›ï¼‰ */
    .wrap{ width:85%; max-width:560px; min-width:280px; }

    .card{
      background:var(--surface);
      border-radius:16px;
      box-shadow:var(--card-shadow);
      border:1px solid rgba(30,42,70,.06);
      padding:16px;
      animation:pop .18s ease-out;
    }
    @keyframes pop{ from{transform:scale(.98); opacity:.0} to{transform:scale(1); opacity:1} }

    .header{
      display:flex; align-items:center; gap:10px;
      margin-bottom:12px; padding-bottom:10px;
      border-bottom:1px dashed rgba(30,42,70,.12);
    }
    .logo{
      width:36px; height:36px; border-radius:12px;
      display:grid; place-items:center; color:#fff;
      background:linear-gradient(135deg,#1a73e8 0%,#4b88f1 55%,#78a6f6 100%);
      box-shadow:0 8px 20px rgba(26,115,232,.35);
      font-size:18px;
    }
    .title{ font-weight:700; font-size:15px; letter-spacing:.2px; }
    .subtitle{ font-size:11px; color:var(--muted); }

    .row{ margin-top:12px; }
    .label{
      font-size:11px; color:var(--muted);
      margin-bottom:6px; display:flex; align-items:center; gap:6px;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ å…±é€š */
    select, input[type=range], button{ width:100%; outline:none; }

    select{
      padding:11px 12px; border-radius:12px;
      border:1px solid rgba(30,42,70,.14);
      background:#fff; font-size:13px; color:var(--text);
      transition:box-shadow .15s ease, border-color .15s ease;
    }
    select:focus{ border-color:var(--primary); box-shadow:0 0 0 4px var(--primary-ring); }

    .range-line{ display:grid; grid-template-columns:1fr auto; align-items:center; gap:10px; }
    input[type=range]{ accent-color:var(--primary); cursor:pointer; }
    #rateVal{
      font-weight:600; font-size:12px; color:var(--primary);
      background:#e8f0fe; padding:2px 8px; border-radius:999px;
    }

    .actions{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:12px; }

    .btn{
      padding:12px; border:none; border-radius:14px;
      font-weight:700; font-size:13px; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      transition:transform .06s ease, box-shadow .15s ease, background .15s ease, opacity .15s ease;
    }
    .btn:active{ transform:translateY(1px); }
    .btn:disabled{ cursor:not-allowed; opacity:.65; }

    .btn-primary{
      color:#fff;
      background:linear-gradient(135deg,#1a73e8 0%,#266fe0 55%,#1557b0 100%);
      box-shadow:0 8px 22px rgba(26,115,232,.35);
    }
    .btn-primary:hover{ background:linear-gradient(135deg,#1a73e8 0%,#1e64d3 55%,#134e9f 100%); }

    .btn-secondary{
      color:#fff;
      background:linear-gradient(135deg,#6b7280 0%,#565d72 55%,#3f465c 100%);
      box-shadow:0 6px 18px rgba(107,114,128,.35);
    }
    .btn-secondary:hover{ background:linear-gradient(135deg,#636a7f 0%,#50566c 55%,#39405a 100%); }

    .status{
      margin-top:10px; font-size:12px; color:var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 8px; border-radius:999px;
      font-size:11px; background:#eef3ff; color:var(--primary);
      border:1px solid #dbe7ff;
    }

    /* ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã®è£œåŠ©ï¼ˆãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¯è¦–åŒ–ï¼‰ */
    .kbd{
      font-size:11px; color:#3b4252; background:#eaeef6; padding:2px 6px; border-radius:6px;
      border:1px solid rgba(30,42,70,.12); margin-left:auto;
      }
      .ai-box{
      min-height:140px;
      padding:12px;
      border-radius:12px;
      background:#f9fafb;
      border:1px solid rgba(30,42,70,.14);
      font-size:13px;
      line-height:1.7;
      white-space:pre-wrap;
      color:#111;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card" role="group" aria-label="éŸ³å£°èª­ã¿ä¸Šã’ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«">
      <div class="header">
        <div class="logo" aria-hidden="true">ğŸ”Š</div>
        <div>
          <div class="title">éŸ³å£°èª­ã¿ä¸Šã’ãƒ‘ãƒãƒ«</div>
          <div class="subtitle">é¸æŠã‚»ãƒ«ã®å†…å®¹ã‚’èª­ã¿ä¸Šã’ã¾ã™</div>
        </div>
        <div class="kbd" title="ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆ">Ctrl+Shift+R å†ç”Ÿ / Ctrl+Shift+S åœæ­¢</div>
      </div>

      <!-- è¨€èªé¸æŠ -->
      <div class="row">
        <div class="label">è¨€èª</div>
        <select id="langSelect" aria-label="èª­ã¿ä¸Šã’è¨€èªã‚’é¸æŠ">
          <option value="ja-JP">æ—¥æœ¬èª</option>
          <option value="mn">ãƒ¢ãƒ³ã‚´ãƒ«èª</option> <!-- mn-MNã§ã¯ãªãmnã§prefixä¸€è‡´ -->
          <option value="en-US">è‹±èª</option>
          <option value="es-ES">ã‚¹ãƒšã‚¤ãƒ³èª</option>
        </select>
      </div>

      <!-- é€Ÿåº¦ -->
      <div class="row">
        <div class="label">é€Ÿåº¦</div>
        <div class="range-line">
          <input type="range" id="rateRange" min="0.5" max="2.0" step="0.1" value="1.0" aria-label="èª­ã¿ä¸Šã’é€Ÿåº¦ã‚’èª¿æ•´">
          <span id="rateVal">1.0x</span>
        </div>
      </div>

      <!-- å®Ÿè¡Œï¼åœæ­¢ -->
      <div class="actions">
        <button id="btnSpeak" class="btn btn-primary" aria-label="é¸æŠç¯„å›²ã‚’èª­ã¿ä¸Šã’">
          <span aria-hidden="true">â–¶</span> èª­ã¿ä¸Šã’
        </button>
        <button id="btnStop" class="btn btn-secondary" aria-label="èª­ã¿ä¸Šã’ã‚’åœæ­¢">
          <span aria-hidden="true">â– </span> åœæ­¢
        </button>
      </div>

      <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ -->
      <div class="status">
        <span class="badge" id="statusBadge">å¾…æ©Ÿä¸­</span>
        <span id="statusText">ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</span>
      </div>
<!-- AIç”Ÿæˆæ–‡ç« ï¼ˆéŸ³å£°èª­ã¿ä¸Šã’ãƒ‘ãƒãƒ«çµ±åˆï¼‰ -->
ã€€ã€€ã€€ã€€<div class="row">
 ã€€ã€€ã€€ <div class="label">ğŸ¤– AIç”Ÿæˆæ–‡ç« ï¼ˆè¦ç´„ï¼‰</div>
 ã€€ã€€ã€€ <div id="aiBox" class="ai-box">
 ã€€ã€€   ã“ã“ã«AIã§ç”Ÿæˆã—ãŸæ–‡ç« ãŒè¡¨ç¤ºã•ã‚Œã¾ã™
  </div>
</div>
<div class="actions">
  <button class="btn btn-primary" onclick="speakAIText()">
    â–¶ AIç”Ÿæˆæ–‡ã‚’èª­ã¿ä¸Šã’
  </button>
</div>

<div class="actions">
  <button class="btn btn-primary" onclick="generateSummary()">
    ğŸ¤– AIè¦ç´„ç”Ÿæˆ
  </button>
</div>

    </div>
  </div>

  <script>
    const aiBox = document.getElementById('aiBox');
    const btnSpeak   = document.getElementById('btnSpeak');
    const btnStop    = document.getElementById('btnStop');
    const statusBadge= document.getElementById('statusBadge');
    const statusText = document.getElementById('statusText');
    const langSelect = document.getElementById('langSelect');
    const rateRange  = document.getElementById('rateRange');
    const rateVal    = document.getElementById('rateVal');

    // é€Ÿåº¦è¡¨ç¤ºã‚’é€£å‹•
    rateRange.addEventListener('input', () => {
      rateVal.textContent = `${parseFloat(rateRange.value).toFixed(1)}x`;
    });

    // èª­ã¿ä¸Šã’é–‹å§‹
    btnSpeak.addEventListener('click', speakSelected);
    // èª­ã¿ä¸Šã’åœæ­¢
    btnStop.addEventListener('click', stopSpeak);

    // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼šCtrl+Shift+R = å†ç”Ÿ / Ctrl+Shift+S = åœæ­¢
    document.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.shiftKey && e.code === 'KeyR') { speakSelected(); }
      if (e.ctrlKey && e.shiftKey && e.code === 'KeyS') { stopSpeak(); }
    });

    function speakSelected(){
      const lang = langSelect.value;
      btnSpeak.disabled = true;
      statusBadge.textContent = 'èª­ã¿å–ã‚Šä¸­';
      statusText.textContent  = 'é¸æŠã‚»ãƒ«ã®å†…å®¹ã‚’å–å¾—ã—ã¦ã„ã¾ã™â€¦';

      // å¿œç­”ãŒé…ã„ã¨ãã®ç°¡æ˜“ãƒ’ãƒ³ãƒˆ
      const timer = setTimeout(() => {
        statusText.textContent = 'å¿œç­”ãŒé…ã„ã§ã™ã€‚ä¿å­˜ãƒ»å†èª­ã¿è¾¼ã¿ãƒ»é¸æŠç¯„å›²ãƒ»é–¢æ•°åï¼ˆgetSelectedTextï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
      }, 10000);

      google.script.run
        .withSuccessHandler((text) => {
          clearTimeout(timer);

          if (!text) {
            statusBadge.textContent = 'ã‚¨ãƒ©ãƒ¼';
            statusText.textContent  = 'é¸æŠç¯„å›²ã«ãƒ†ã‚­ã‚¹ãƒˆãŒã‚ã‚Šã¾ã›ã‚“';
            btnSpeak.disabled = false;
            return;
          }

          // æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢ã—ã¦ã‹ã‚‰é–‹å§‹
          window.speechSynthesis.cancel();

          const ut = new SpeechSynthesisUtterance(text);
          ut.lang  = lang;
          ut.rate  = parseFloat(rateRange.value);

          // éŸ³å£°ã‚¨ãƒ³ã‚¸ãƒ³ã®å®‰å®šæŒ‡å®šï¼ˆmnå„ªå…ˆï¼ä»–è¨€èªã‚‚å¯èƒ½ãªã‚‰å‰²å½“ï¼‰
          const voices = window.speechSynthesis.getVoices();
          if (lang === 'mn') {
            const mnVoice = voices.find(v => v.lang && v.lang.startsWith('mn'));
            if (mnVoice) ut.voice = mnVoice;
          } else {
            const genericVoice = voices.find(v => v.lang && v.lang.toLowerCase().startsWith(lang.toLowerCase()));
            if (genericVoice) ut.voice = genericVoice;
          }

          ut.onstart = () => {
            statusBadge.textContent = 'å†ç”Ÿä¸­';
            statusText.textContent  = 'éŸ³å£°ã‚’å†ç”Ÿã—ã¦ã„ã¾ã™â€¦';
          };
          ut.onend   = () => {
            statusBadge.textContent = 'å®Œäº†';
            statusText.textContent  = 'èª­ã¿ä¸Šã’ãŒå®Œäº†ã—ã¾ã—ãŸ';
            btnSpeak.disabled = false;
          };
          ut.onerror = (e) => {
            statusBadge.textContent = 'ã‚¨ãƒ©ãƒ¼';
            statusText.textContent  = 'èª­ã¿ä¸Šã’ã‚¨ãƒ©ãƒ¼' + (e?.message ? 'ï¼š' + e.message : '');
            btnSpeak.disabled = false;
          };

          window.speechSynthesis.speak(ut);
        })
        .withFailureHandler((err) => {
          clearTimeout(timer);
          statusBadge.textContent = 'ã‚¨ãƒ©ãƒ¼';
          statusText.textContent  = 'å–å¾—ã‚¨ãƒ©ãƒ¼ï¼š' + err;
          console.error(err);
          btnSpeak.disabled = false;
        })
        .getSelectedText();
    }

    function stopSpeak(){
      window.speechSynthesis.cancel();
      statusBadge.textContent = 'åœæ­¢';
      statusText.textContent  = 'èª­ã¿ä¸Šã’ã‚’åœæ­¢ã—ã¾ã—ãŸ';
      btnSpeak.disabled = false;
    }

    // voices äº‹å‰ãƒ­ãƒ¼ãƒ‰ï¼ˆåˆå›ç©ºå¯¾ç­–ï¼‰
    window.speechSynthesis.getVoices();
    if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = () => { /* å¿…è¦ãªã‚‰ã“ã“ã§å‡¦ç† */ };
    }
ã€€ã€€ã€€function generateSummary(){
  ã€€ã€€const lang = langSelect.value; // â˜…é¸æŠä¸­ã®è¨€èª

 ã€€ã€€ aiBox.textContent = 'AIãŒè¦ç´„ã‚’ç”Ÿæˆã—ã¦ã„ã¾ã™â€¦';

 ã€€ google.script.run
    .withSuccessHandler((text) => {
      aiBox.textContent = text;
    })
    .withFailureHandler((err) => {
      aiBox.textContent = 'ã‚¨ãƒ©ãƒ¼ï¼š' + err;
    })
    .summarizeSelectedData(lang); // â˜…å¼•æ•°ã§æ¸¡ã™
}
function speakAIText(){

  // â‘  AIè¡¨ç¤ºã‚¨ãƒªã‚¢ã®æ–‡ç« ã‚’å–å¾—
  const text = aiBox.textContent;

  // â‘¡ ã¾ã ä½•ã‚‚ç”Ÿæˆã•ã‚Œã¦ã„ãªã„å ´åˆã¯èª­ã¾ãªã„
  if (!text || text.startsWith('ã“ã“ã«')) {
    statusBadge.textContent = 'æœªç”Ÿæˆ';
    statusText.textContent  = 'AIæ–‡ç« ãŒã¾ã ç”Ÿæˆã•ã‚Œã¦ã„ã¾ã›ã‚“';
    return;
  }

  // â‘¢ æ—¢å­˜ã®èª­ã¿ä¸Šã’ã‚’åœæ­¢
  window.speechSynthesis.cancel();

  // â‘£ èª­ã¿ä¸Šã’è¨­å®š
  const ut = new SpeechSynthesisUtterance(text);
  ut.lang = langSelect.value;
  ut.rate = parseFloat(rateRange.value);

  // â‘¤ ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é€£å‹•ï¼ˆæ—¢å­˜UIã‚’å†åˆ©ç”¨ï¼‰
  ut.onstart = () => {
    statusBadge.textContent = 'å†ç”Ÿä¸­';
    statusText.textContent  = 'AIç”Ÿæˆæ–‡ã‚’èª­ã¿ä¸Šã’ã¦ã„ã¾ã™â€¦';
  };

  ut.onend = () => {
    statusBadge.textContent = 'å®Œäº†';
    statusText.textContent  = 'AIç”Ÿæˆæ–‡ã®èª­ã¿ä¸Šã’ãŒå®Œäº†ã—ã¾ã—ãŸ';
  };

  ut.onerror = () => {
    statusBadge.textContent = 'ã‚¨ãƒ©ãƒ¼';
    statusText.textContent  = 'AIç”Ÿæˆæ–‡ã®èª­ã¿ä¸Šã’ã«å¤±æ•—ã—ã¾ã—ãŸ';
  };

  // â‘¥ å†ç”Ÿ
  window.speechSynthesis.speak(ut);
}
  </script>
</body>
</html>