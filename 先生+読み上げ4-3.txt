function onOpen() {
  const ui = SpreadsheetApp.getUi();
  ui.createMenu('★音声読み上げ')
    .addItem('読み上げパネルを表示', 'showSidebar')
    .addToUi();
    ui.createMenu('AIツール')
    .addItem('選択範囲を説明する', 'summarizeSelectedData')
    .addToUi();
    }
function showSidebar() {
  const html = HtmlService.createTemplateFromFile('Dialog').evaluate()
    .setTitle('音声読み上げパネル')
    .setXFrameOptionsMode(HtmlService.XFrameOptionsMode.ALLOWALL);
  SpreadsheetApp.getUi().showSidebar(html);
}
function getSelectedText() {
  try {
    const ss = SpreadsheetApp.getActive();
    const sheet = ss.getActiveSheet();
    const range = ss.getActiveRange();

    // ★ 計測（実行ログで確認できる）
    Logger.log('[getSelectedText] sheet=%s range=%s', sheet ? sheet.getName() : '(none)', range ? range.getA1Notation() : '(none)');

    if (!range) {
      Logger.log('[getSelectedText] range is null');
      return "";
    }

    const values = range.getDisplayValues();
    Logger.log('[getSelectedText] rows=%s cols=%s', values.length, values[0] ? values[0].length : 0);

    const text = values
      .flat()
      .map(v => String(v).trim())
      .filter(Boolean)
      .join('。 ');

    Logger.log('[getSelectedText] result length=%s', text.length);
    return text;
  } catch (e) {
    // ★ 例外を明示化（withFailureHandler にメッセージが渡る）
    Logger.log('[getSelectedText] error: %s', e && e.stack ? e.stack : e);
    throw new Error('getSelectedText failed: ' + (e && e.message ? e.message : e));
  }
}