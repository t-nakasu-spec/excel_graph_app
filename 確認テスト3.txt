<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>クイズ（複数問表示）</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { --bg:#f7f9fc; --card:#ffffff; --accent:#2563eb; --text:#111827; --muted:#6b7280; --ok:#16a34a; --ng:#ef4444; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0; background: var(--bg); color: var(--text);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", "Meiryo", sans-serif;
       min-height: 100vh;
    　　padding: 16px 0;
    }
    .container {
      width: 100%; max-width: 960px; background: var(--card);
      border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08); margin: 16px;
    }
    h1 { margin: 0 0 8px; font-size: 20px; }
    .status { font-size: 13px; color: var(--muted); }

    .userbox { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin: 8px 0; }
    .userbox label { font-size: 13px; color: var(--muted); }
    .userbox input {
      width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px;
      font-size: 14px;
    }

    .controls { display: flex; gap: 8px; margin-top: 8px; }
    .btn {
      background: var(--accent); color: #fff; border: none; border-radius: 8px;
      padding: 10px 12px; font-weight: 600; cursor: pointer;
    }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn.muted { background: #6b7280; }

    .progress { height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden; margin: 12px 0; }
    .progress > div { width: 0%; height: 100%; background: var(--accent); transition: width .2s ease; }

    .question-block { border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
    .question-title { font-size: 16px; font-weight: 600; margin-bottom: 8px; }
    .choices { display: grid; gap: 8px; }
    .choice { display: flex; align-items: center; gap: 8px; cursor: pointer; }
    .choice:hover { background: #f3f4f6; border-radius: 4px; }
    textarea { width: 100%; min-height: 80px; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px; }
    .footer { display: flex; gap: 8px; justify-content: space-between; margin-top: 8px; }
    #quizArea { display: none; }
    .q-index { font-size: 14px; color: var(--muted); margin-bottom: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>基礎知識確認テスト</h1>
    <div class="status" id="status">未開始</div>

    <!-- 受験者情報 -->
    <div class="userbox">
      <div>
        <label>氏名</label>
        <input id="userName" type="text" placeholder="例：山田 太郎">
      </div>
      <div>
        <label>社員番号</label>
        <input id="empNo" type="text" placeholder="例：12345">
      </div>
    </div>

    <div class="controls">
      <button class="btn" onclick="loadQuiz(true)">問題を読み込む</button>
    </div>

    <!-- クイズエリア -->
    <div id="quizArea">
      <div class="progress"><div id="bar"></div></div>
      <div class="q-index" id="qIndex"></div>
      <div id="choiceBox"></div>
      <div class="footer">
        <button class="btn muted" id="prevBtn" onclick="prev()">前へ</button>
        <button class="btn" id="nextBtn" onclick="next()">次へ</button>
        <button class="btn" style="background:#16a34a;" onclick="finish()">終了して保存</button>
      </div>
    </div>
  </div>

  <script>
    // ========== ヘルパー関数 ==========
    function $(id) { return document.getElementById(id); }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function escapeAttr(str) {
      return String(str).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    }

    function norm(s) {
      return String(s ?? '')
        .replace(/\u3000/g, ' ')
        .trim()
        .toLowerCase();
    }

    function requireUser() {
      const name = $('userName').value.trim();
      const empNo = $('empNo').value.trim();
      if (!name || !empNo) {
        return null;
      }
      return { name, empNo };
    }

    // ========== グローバル変数 ==========
    let questions = [];
    let answers = [];
    let pageIndex = 0;
    const PAGE_SIZE = 5;

    // ========== メイン処理 ==========
    function loadQuiz(force) {
      const user = requireUser();
      if (!user) {
        $('status').textContent = '氏名／社員番号が未入力です';
        return;
      }

      $('status').textContent = '読み込み中…';
      if (force) {
        questions = [];
        answers = [];
        pageIndex = 0;
      }

      google.script.run
        .withSuccessHandler(function(data) {
          questions = data || [];
          answers = new Array(questions.length).fill(null);
          pageIndex = 0;
          $('quizArea').style.display = questions.length ? 'block' : 'none';
          $('status').textContent = '問題数: ' + questions.length + ' / 受験者: ' + user.name + '（社員番号: ' + user.empNo + '）';
          renderPage(0);
        })
        .withFailureHandler(function(err) {
          alert('読み込みエラー: ' + (err?.message || err));
          $('status').textContent = '読み込みに失敗しました';
        })
        .getQuizData();
    }

    function renderPage(page) {
      if (page === undefined) page = pageIndex;
      const total = questions.length;
      const pages = Math.ceil(total / PAGE_SIZE);
      pageIndex = Math.max(0, Math.min(page, pages - 1));

      const answeredCount = answers.filter(function(a) { return a !== null; }).length;
      $('bar').style.width = total ? Math.round(answeredCount / total * 100) + '%' : '0%';
      $('qIndex').textContent = total ? 'ページ ' + (pageIndex + 1) + '/' + pages + '（全 ' + total + ' 問）' : '';

      const start = pageIndex * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);
      const slice = questions.slice(start, end);

      const box = $('choiceBox');
      box.innerHTML = '';

      slice.forEach(function(q, localIdx) {
        const qIdx = start + localIdx;
        const wrapper = document.createElement('div');
        wrapper.className = 'question-block';

        const title = document.createElement('div');
        title.className = 'question-title';
        title.textContent = 'Q' + (qIdx + 1) + '. ' + q.question;
        wrapper.appendChild(title);

        const inner = document.createElement('div');
        inner.className = 'choices';

        if (q.type === '選択') {
          if (q.multi) {
            q.choices.forEach(function(c, i) {
              const id = 'q' + qIdx + '_choice_' + i;
              const row = document.createElement('label');
              row.className = 'choice';
              row.innerHTML =
                '<input type="checkbox" name="q' + qIdx + '_choice" id="' + id + '" value="' + escapeAttr(c) + '">' +
                '<span>' + escapeHtml(c) + '</span>';
              inner.appendChild(row);
            });
          } else {
            q.choices.forEach(function(c, i) {
              const id = 'q' + qIdx + '_choice_' + i;
              const row = document.createElement('label');
              row.className = 'choice';
              row.innerHTML =
                '<input type="radio" name="q' + qIdx + '_choice" id="' + id + '" value="' + escapeAttr(c) + '">' +
                '<span>' + escapeHtml(c) + '</span>';
              inner.appendChild(row);
            });
          }
        } else {
          const ta = document.createElement('textarea');
          ta.id = 'q' + qIdx + '_freeText';
          ta.placeholder = '回答を入力';
          inner.appendChild(ta);
        }

        // 回答復元
        const a = answers[qIdx];
        if (a && a.response !== undefined && a.response !== null) {
          if (q.type === '選択') {
            const inputs = inner.querySelectorAll('input[name="q' + qIdx + '_choice"]');
            inputs.forEach(function(inp) {
              if (Array.isArray(a.response)) {
                if (a.response.map(norm).includes(norm(inp.value))) inp.checked = true;
              } else {
                if (norm(inp.value) === norm(a.response)) inp.checked = true;
              }
            });
          } else {
            const ta = inner.querySelector('#q' + qIdx + '_freeText');
            if (ta) ta.value = Array.isArray(a.response) ? (a.response[0] ?? '') : (a.response ?? '');
          }
        }

        wrapper.appendChild(inner);
        box.appendChild(wrapper);
      });

      $('prevBtn').disabled = (pageIndex === 0);
      $('nextBtn').disabled = (pageIndex >= pages - 1);
    }

    function saveCurrentPage() {
      const total = questions.length;
      const start = pageIndex * PAGE_SIZE;
      const end = Math.min(start + PAGE_SIZE, total);

      for (let qIdx = start; qIdx < end; qIdx++) {
        const q = questions[qIdx];
        let response;

        if (q.type === '選択') {
          const inputs = document.querySelectorAll('input[name="q' + qIdx + '_choice"]');
          if (q.multi) {
            const selected = Array.from(inputs).filter(function(inp) { return inp.checked; }).map(function(inp) { return inp.value; });
            response = selected.length ? selected : null;
          } else {
            const sel = Array.from(inputs).find(function(inp) { return inp.checked; });
            response = sel ? sel.value : null;
          }
        } else {
          const ta = document.getElementById('q' + qIdx + '_freeText');
          const txt = (ta?.value || '').trim();
          response = txt ? txt : null;
        }

        if (response === null) {
          answers[qIdx] = null;
        } else {
          answers[qIdx] = {
            response: response,
            corrects: Array.isArray(q.corrects) ? q.corrects : (q.correct ? [q.correct] : []),
            correct: q.correct,
            question: q.question
          };
        }
      }
      return true;
    }

    function next() {
      if (!saveCurrentPage()) return;
      const total = questions.length;
      const pages = Math.ceil(total / PAGE_SIZE);
      if (pageIndex < pages - 1) {
        pageIndex++;
        renderPage(pageIndex);
        window.scrollTo(0, 0);
      } else {
        alert('最終ページです。終了して保存してください。');
      }
    }

    function prev() {
      if (!saveCurrentPage()) return;
      if (pageIndex > 0) {
        pageIndex--;
        renderPage(pageIndex);
        window.scrollTo(0, 0);
      }
    }

    function finish() {
      const user = requireUser();
      if (!user) {
        alert('氏名・社員番号を入力してください');
        return;
      }

      if (!saveCurrentPage()) return;

      const notAnswered = answers
        .map(function(a, i) { return (a === null || a === undefined) ? (i + 1) : null; })
        .filter(function(v) { return v !== null; });

      if (notAnswered.length) {
        const go = confirm('未回答の問題があります（Q' + notAnswered.join(', ') + '）。このまま保存しますか？');
        if (!go) return;
      }

      const payload = answers
        .map(function(a, i) {
          const q = questions[i];
          if (!a) return null;
          return {
            timestamp: new Date().toISOString(),
            question: q.question,
            response: a.response,
            correct: q.correct,
            corrects: q.corrects,
            type: q.type,
            choices: q.choices,
            points: Number(q.points || 0)
          };
        })
        .filter(function(r) { return r !== null; });

      $('status').textContent = '保存中…';

      google.script.run
        .withSuccessHandler(function(res) {
          alert('保存しました（' + res.saved + '件）\n合計点: ' + (res.total ?? 0) + ' 点');
          $('status').textContent = '保存完了！ 合計点: ' + (res.total ?? 0) + ' 点';
        })
        .withFailureHandler(function(err) {
          alert('保存エラー: ' + (err?.message || err));
          $('status').textContent = '保存に失敗しました';
        })
        .submitResults(payload, user);
    }
  </script>
</body>
</html>
