function onOpen() {
  SpreadsheetApp.getUi()
    .createMenu('基礎知識確認テスト')
    .addItem('テスト開始(ダイアログ）)', 'showDialogQuiz')
    .addSeparator()
    .addItem('【ID】このファイルをターゲットに設定', 'setSpreadsheetId_auto')  // ← 自動取得
    .addItem('【ID】URL/IDを手動で登録', 'setSpreadsheetId_prompt')            // ← 手動登録
    .addItem('【ID】現在のターゲットを確認', 'showSpreadsheetId')              // ← 確認
    .addSeparator()
    .addItem('テスト開始（Web）', 'openWebApp')
    .addItem('WebアプリURLを登録', 'setWebAppUrl_prompt')
    .addToUi();
}

/** ─────────────────────────────────────────────
 *  ターゲットSSのIDを ScriptProperties に保存・参照するユーティリティ
 *  キー: TARGET_SPREADSHEET_ID
 *  ───────────────────────────────────────────── */
function setSpreadsheetId_auto() {
  const ui = SpreadsheetApp.getUi();
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  if (!ss) {
    ui.alert('アクティブなスプレッドシートが見つかりません。シートから「拡張機能→Apps Script」を開いてください。');
    return;
  }
  const id = ss.getId();
  PropertiesService.getScriptProperties().setProperty('TARGET_SPREADSHEET_ID', id);
  ui.alert('このスプレッドシートをターゲットに設定しました。\nID: ' + id);
}

function setSpreadsheetId_prompt() {
  const ui = SpreadsheetApp.getUi();
  const res = ui.prompt('ターゲットのスプレッドシートURLまたはIDを貼り付けてください',
    '例）https://docs.google.com/spreadsheets/d/＜ID＞/edit または ＜ID＞', ui.ButtonSet.OK_CANCEL);
  if (res.getSelectedButton() !== ui.Button.OK) return;

  const raw = (res.getResponseText() || '').trim();
  const id = extractSpreadsheetId_(raw);
  if (!id) {
    ui.alert('入力内容からスプレッドシートIDを取得できませんでした。\nURL形式やID文字列をご確認ください。');
    return;
  }

  // ID妥当性チェック（存在確認）
  try {
    const ss = SpreadsheetApp.openById(id);
    if (!ss) throw new Error('openByIdが失敗');
  } catch (e) {
    ui.alert('指定IDのスプレッドシートを開けませんでした。\n権限や共有設定を確認してください。\nID: ' + id + '\nError: ' + e);
    return;
  }

  PropertiesService.getScriptProperties().setProperty('TARGET_SPREADSHEET_ID', id);
  ui.alert('ターゲットIDを登録しました。\nID: ' + id);
}

function showSpreadsheetId() {
  const ui = SpreadsheetApp.getUi();
  const id = PropertiesService.getScriptProperties().getProperty('TARGET_SPREADSHEET_ID') || '(未登録)';
  ui.alert('現在のターゲットSS ID:\n' + id);
}

/** 入力文字列（URL/ID）からSS IDを抽出 */
function extractSpreadsheetId_(input) {
  const s = String(input || '').trim();

  // 1) そのままIDっぽい（/ や ? が含まれない、長めの英数・ハイフン・アンダースコア）
  if (/^[A-Za-z0-9_\-]{20,}$/.test(s)) return s;

  // 2) URL形式から /spreadsheets/d/＜ID＞/ を抽出
  const m = s.match(/\/spreadsheets\/d\/([A-Za-z0-9_\-]+)/);
  if (m && m[1]) return m[1];

  // 3) 余分なクエリやフラグメントを削除したID候補の抽出（保険）
  const m2 = s.match(/([A-Za-z0-9_\-]{20,})/);
  if (m2 && m2[1]) return m2[1];

  return '';
}

/** 保存済みターゲットSSを開く（なければエラー） */
function openTargetSpreadsheet_() {
  const id = PropertiesService.getScriptProperties().getProperty('TARGET_SPREADSHEET_ID');
  if (!id) throw new Error('ターゲットのスプレッドシートIDが未設定です。「【ID】このファイルをターゲットに設定」または「【ID】URL/IDを手動で登録」を実行してください。');
  return SpreadsheetApp.openById(id);
}

/** 文字列正規化（前後空白・大小・全角カンマ/スラッシュ等の基本対策） */
function _norm_(s) {
  return String(s ?? '')
    .replace(/\u3000/g, ' ')      // 全角スペース → 半角
    .trim()
    .toLowerCase();
}

/** G列の正解セルをトークン配列へ（カンマ・読点・スラッシュ・セミコロン・改行を区切り） */
function _splitTokens_(s) {
  return String(s ?? '')
    .split(/[,\u3001\/\uFF0C\uFF0F;\uFF1B\r\n]+/) // , 、 ／ ， ／ ; ； 改行
    .map(t => t.trim())
    .filter(t => t !== '');
}

/** トークン（A,B,C…／1,2,3…／テキスト）を選択肢テキストへマッピング */
function _tokensToChoiceTexts_(tokens, choices) {
  const mapLetter = { a:0, b:1, c:2, d:3, e:4, f:5 }; // C〜Fまで対応
  const out = [];
  const choicesNorm = choices.map(c => _norm_(c));
  tokens.forEach(tok => {
    const n = _norm_((tok));
    let idx = -1;

    // 1) テキスト一致（大小・空白無視）
    const byText = choicesNorm.indexOf(n);
    if (byText >= 0) {
      out.push(choices[byText]);
      return;
    }
    // 2) A~F 指定
    if (n in mapLetter) {
      idx = mapLetter[n];
      if (idx >= 0 && idx < choices.length) out.push(choices[idx]);
      return;
    }
    // 3) 数字 1~6 指定
    if (/^\d+$/.test(n)) {
      idx = parseInt(n, 10) - 1;
      if (idx >= 0 && idx < choices.length) out.push(choices[idx]);
      return;
    }
    // 4) マッチなし → 無視（警告はしない）
  });
  // 重複除去
  return Array.from(new Set(out));
}

/** 集合一致（配列同士を大小・空白無視で比較、順不同） */
function _setEquals_(arrA, arrB) {
  const A = Array.from(new Set(arrA.map(_norm_))).sort();
  const B = Array.from(new Set(arrB.map(_norm_))).sort();
  if (A.length !== B.length) return false;
  for (let i = 0; i < A.length; i++) if (A[i] !== B[i]) return false;
  return true;
}


/** 選択肢テキスト配列を A/B/C... のラベル配列へ変換（大小・空白無視で一致） */
function _textsToLetters_(items, choices) {
  if (!Array.isArray(items)) items = [String(items ?? '')];
  const letters = ['A','B','C','D','E','F'];
  const choicesNorm = (choices || []).map(_norm_);
  const out = [];

  items.forEach(txt => {
    const n = _norm_(txt);
    const idx = choicesNorm.indexOf(n);
    if (idx >= 0 && idx < letters.length) {
      out.push(letters[idx]);
    } else {
      // 一致しない場合は保険：そのまま（記録を欠損させない）
      out.push(txt);
    }
  });

  // 重複除去
  return Array.from(new Set(out));
}


// ① スプレッドシート内で開く（安定ルート）
function showDialogQuiz() {
  const tmpl = HtmlService.createTemplateFromFile('FullQuiz');
  const html = tmpl.evaluate()
    .setTitle('5S/一般クイズ（全問）')
    .setWidth(1200)
    .setHeight(800);
  SpreadsheetApp.getActiveSpreadsheet().show(html);
}

// ② Webアプリ本体（URLで全画面表示）
function doGet() {
  const tmpl = HtmlService.createTemplateFromFile('FullQuiz');
  return tmpl.evaluate().setTitle('5S/一般クイズ（全問）');
}
function checkKey() {
  const key = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  Logger.log(key ? "キーは設定されています" : "キーが空です！");
}
function listAvailableModels() {
  const apiKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  const url = `https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`;
  const res = UrlFetchApp.fetch(url, {muteHttpExceptions: true});
  Logger.log(res.getContentText());
}

/** Gemini APIを使って記述式の回答を判定する */
function askAiToJudge(question, response, criteria) {
  const apiKey = PropertiesService.getScriptProperties().getProperty('GEMINI_API_KEY');
  if (!apiKey) {
    Logger.log('Error: APIキーが設定されていません。');
    return false;
  }

  const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
  
  const prompt = `
あなたは公平な採点官です。以下の【問題】に対する【ユーザーの回答】を、【判定基準】に従って採点してください。
判定は「正解」または「不正解」のいずれか1単語のみで出力してください。解説は不要です。

【問題】: ${question}
【判定基準】: ${criteria}
【ユーザーの回答】: ${response}
`;

  const payload = {
    contents: [{ 
      parts: [{ text: prompt }] 
    }]
  };

  const options = {
    method: 'post',
    contentType: 'application/json',
    payload: JSON.stringify(payload),
    muteHttpExceptions: true // これをtrueにすると詳細なエラー理由がログに残ります
  };

  try {
    const res = UrlFetchApp.fetch(url, options);
    const resText = res.getContentText();
    const resJson = JSON.parse(resText);

    // エラーレスポンスが返ってきた場合のチェック
    if (resJson.error) {
      Logger.log('API Error: ' + resText);
      return false;
    }

    const aiText = resJson.candidates[0].content.parts[0].text.trim();
    Logger.log(`AI判定結果: ${aiText} (回答: ${response})`);
    
    // 「正解」という文字が含まれていれば合格
    return aiText.includes('正解');
  } catch (e) {
    Logger.log('AI判定で例外が発生しました: ' + e);
    return false;
  }
}
/**
 * 問題データ（全件）を取得
 * 記述式の場合、C列を「判定基準」として保持するように修正
 */
function getQuizData() {
  const ss = (typeof openTargetSpreadsheet_ === 'function')
    ? openTargetSpreadsheet_()
    : SpreadsheetApp.getActiveSpreadsheet();
    
  if (!ss) throw new Error('ターゲットのスプレッドシートが見つかりません');

  const sheet = ss.getSheetByName('問題マスター');
  if (!sheet) throw new Error('シート「問題マスター」が見つかりません');

  const values = sheet.getDataRange().getValues();
  if (values.length <= 1) throw new Error('問題マスターに問題がありません（2行目以降）');

  // 列定義（A=0, B=1, ...）
  const COL_QUESTION = 0;       // A列: 問題文
  const COL_TYPE     = 1;       // B列: 種別（選択 or 記述）
  const COL_CHOICES_START = 2;  // C列: 選択肢1 / 記述式の場合は「判定基準」
  const COL_CHOICES_END   = 6;  // G列: 選択肢5
  const COL_ANSWER   = 7;       // H列: 正解（選択式用）
  const COL_POINTS   = 8;       // I列: 配点

  const questions = values.slice(1).map((row, index) => {
    const question = String(row[COL_QUESTION] ?? '').trim();
    if (!question) return null; // 空行スキップ

    const typeRaw = String(row[COL_TYPE] ?? '').trim();
    
    // C列〜G列を取得
    const rawChoices = row.slice(COL_CHOICES_START, COL_CHOICES_END + 1)
                          .map(c => String(c ?? '').trim());

    // 実際の選択肢（空文字を除外したもの）
    const activeChoices = rawChoices.filter(s => s !== '');

    // 種別の確定
    // B列が「選択」かつ選択肢が存在すれば「選択」、それ以外は「記述」
    const type = (typeRaw === '選択' && activeChoices.length > 0) ? '選択' : '記述';

    const correctCell = String(row[COL_ANSWER] ?? '').trim();
    const tokens = _splitTokens_(correctCell);
    
    let corrects = [];
    let multi = false;
    let finalChoices = [];

    if (type === '選択') {
      // 選択式の場合：通常の選択肢リスト
      finalChoices = activeChoices;
      corrects = _tokensToChoiceTexts_(tokens, finalChoices);
      multi = corrects.length > 1;
      // 万が一記号変換に失敗した場合の保険
      if (corrects.length === 0 && correctCell) { 
        corrects = [correctCell]; 
        multi = false; 
      }
    } else {
      // 記述式の場合：
      // C列（rawChoices[0]）を判定基準として扱うが、
      // フロントエンドにそのまま渡せるよう choices 配列の先頭に入れておく
      finalChoices = rawChoices.length > 0 ? [rawChoices[0]] : ["主旨が合っていること"];
      corrects = tokens.length ? tokens : (correctCell ? [correctCell] : []);
      multi = false;
    }

    const points = Number(row[COL_POINTS]) || 0;

    return { 
      question, 
      type, 
      choices: finalChoices, // 記述式なら [判定基準], 選択式なら [選択肢1, 2...]
      correct: correctCell, 
      corrects, 
      multi, 
      points 
    };
  }).filter(q => q !== null);

  return questions;
}

/**
 * 結果の保存とAI採点
 * @param {Array<Object>} results フロントエンドからの回答データ
 * @param {Object} user 受験者情報 {name, empNo}
 */
function submitResults(results, user) {
  const ss = (typeof openTargetSpreadsheet_ === 'function')
    ? openTargetSpreadsheet_()
    : SpreadsheetApp.getActiveSpreadsheet();
  
  if (!ss) throw new Error('スプレッドシートが見つかりません');

  let resultSheet = ss.getSheetByName('結果シート');
  if (!resultSheet) {
    resultSheet = ss.insertSheet('結果シート');
    resultSheet.appendRow(['日時', '氏名', '社員番号', '問題文', '回答', '正解例/判定基準', '判定', '得点']);
  }

  const name = String(user?.name ?? '').trim();
  const empNo = String(user?.empNo ?? '').trim();
  let totalPoints = 0;

  // 各回答の処理
  const rows = (results || []).map(r => {
    const ts = r.timestamp ? new Date(r.timestamp) : new Date();
    const qText = r.question ?? '';
    const type = r.type ?? '記述';
    const choices = Array.isArray(r.choices) ? r.choices : [];
    const pts = Number(r.points || 0);
    
    // 回答の配列化（選択式：配列、記述式：文字列の[0]）
    const respArr = Array.isArray(r.response) ? r.response : [String(r.response ?? '')];
    
    let isCorrect = false;
    let responseDisplay = "";
    let correctDisplay = r.correct ?? ""; // スプレッドシート上の正解セル

    // --- 判定ロジック ---
    if (type === '選択') {
      // 【選択式】A/B/C記号に変換して比較
      const corrArr = Array.isArray(r.corrects) ? r.corrects : _splitTokens_(String(r.correct ?? ''));
      const respLetters = _textsToLetters_(respArr, choices);
      const corrLetters = _textsToLetters_(corrArr, choices);
      
      isCorrect = _setEquals_(respLetters, corrLetters);
      
      responseDisplay = respLetters.join(' | ');
      correctDisplay = corrLetters.join(' | ');

    } else {
      // 【記述式】AI（Gemini）による判定
      // C列(choices[0])を判定基準として使用
      const aiCriteria = (choices.length > 0) ? choices[0] : "主旨が合っていること";
      
      // AI判定を呼び出し
      isCorrect = askAiToJudge(qText, respArr[0], aiCriteria);
      
      responseDisplay = respArr[0];
      // 記述式の場合、正解列には「判定基準」を載せておくと後で確認しやすい
      correctDisplay = "【基準】: " + aiCriteria;
    }

    // 得点計算
    const score = isCorrect ? pts : 0;
    totalPoints += score;
    const judgment = isCorrect ? '正解' : '不正解';

    return [ts, name, empNo, qText, responseDisplay, correctDisplay, judgment, score];
  });

  // 1. 各問題の結果を書き込み
  if (rows.length > 0) {
    const startRow = resultSheet.getLastRow() + 1;
    resultSheet.getRange(startRow, 1, rows.length, rows[0].length).setValues(rows);
  }

  // 2. 受験者ごとの「合計点」行を追加
  const lastTs = rows.length ? rows[rows.length - 1][0] : new Date();
  resultSheet.appendRow([lastTs, name, empNo, '--- 合計点 ---', '', '', '', totalPoints]);

  // 見栄えの調整（合計行を太字に）
  const lastRowIdx = resultSheet.getLastRow();
  resultSheet.getRange(lastRowIdx, 1, 1, resultSheet.getLastColumn()).setFontWeight('bold');

  return { saved: rows.length, total: totalPoints };
}



/* ── 任意：WebアプリURLの登録＆起動（メニュー用） ── */
function setWebAppUrl(url) {
  PropertiesService.getScriptProperties().setProperty('WEB_APP_URL', url);
}


function setWebAppUrl_prompt() {
  const ui = SpreadsheetApp.getUi();
  const res = ui.prompt('WebアプリURL（/exec）を貼り付けてください', 
                        'https://script.google.com/macros/s/…/exec', 
                        ui.ButtonSet.OK_CANCEL);
  if (res.getSelectedButton() !== ui.Button.OK) return;

  // 余計な全角スペース・改行・スマートクォートを除去
  let url = (res.getResponseText() || '')
              .replace(/[“”‘’]/g, '"')   // 変換用（念のため）
              .trim();

  // ▼ 許可するURLパターン
  //  - https://script.google.com/macros/s/{DEPLOY_ID}/exec
  //  - https://script.google.com/a/macros/{DOMAIN}/s/{DEPLOY_ID}/exec
  const ok =
    /^https:\/\/script\.google\.com\/macros\/s\/[^/]+\/exec$/.test(url) ||
    /^https:\/\/script\.google\.com\/a\/macros\/[^/]+\/s\/[^/]+\/exec$/.test(url);

  if (!ok) {
    ui.alert(
      'URL形式が正しくありません。\n' +
      '次のいずれかの形で入力してください：\n' +
      '・https://script.google.com/macros/s/＜ID＞/exec\n' +
      '・https://script.google.com/a/macros/＜ドメイン＞/s/＜ID＞/exec'
    );
    return;
  }

  setWebAppUrl(url);
  ui.alert('URLを登録しました');
}


function getWebAppUrl_() {
  return PropertiesService.getScriptProperties().getProperty('WEB_APP_URL') || '';
}

function openWebApp() {
  const url = getWebAppUrl_();
  const ui = SpreadsheetApp.getUi();
  if (!url) {
    const html = HtmlService.createHtmlOutput('<p>WebアプリURLが未登録です。「問題マスター → WebアプリURLを登録」から登録してください。</p>')
      .setTitle('起動エラー');
    SpreadsheetApp.getActiveSpreadsheet().show(html); // ダイアログ表示
    return;
  }
  const html = HtmlService.createHtmlOutput(`<p><a href="${url}" target="_blank" rel="noopener">ここをクリックして全画面クイズ（Web版）を開く</a></p>`)
    .setTitle('Webアプリ起動');
  SpreadsheetApp.getActiveSpreadsheet().show(html);
}